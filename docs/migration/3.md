Migration from 3.x
====

4.x introduces a number of breaking changes in the following libraries: _DotNext_, _DotNext.Threading_, _DotNext.Net.Cluster_, _DotNext.AspNetCore.Cluster_.

# Core Library

## WaitAsync and ContinueWithTimeout methods
Both methods have been removed from the library because they can be replaced with [WaitAsync](https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.waitasync) method from .NET 6 standard library.

## Box&lt;T&gt;
`DotNext.Runtime.Box<T>` value type is replaced by `DotNext.Runtime.Reference<T>` value type. A new type allows to hold the reference to the various memory locations: array element, static of instance field, boxed value type. As a result, you need to use the factory method to make a reference to the boxed value:
```csharp
using DotNext.Runtime;

object boxed = 25;
Reference<int> referenceToBoxedValue = Reference.Unbox<int>(boxed);
Console.WriteLine(referenceToBoxedValue.Target);
```

# IO
`SequenceBinaryReader` has been renamed to `SequenceReader`.

## IAsyncBinaryReader and IAsyncBinaryWriter
`IAsyncBinaryWriter` prior to 3.x had a set of methods (`WriteGuidAsync`, `WriteDateTimeAsync`) for encoding various value types as a string using the specified encoding. Starting from .NET 6, there is a special public interface [ISpanFormattable](https://docs.microsoft.com/en-us/dotnet/api/system.ispanformattable) that is implemented by all formattable data types in .NET Base Class Library. It's reasonable to offer a single method that can work with any type implementing the necessary interface instead of multiple methods for each formattable data type.
```csharp
using System.Text;
using DotNext.IO;

IAsyncBinaryWriter writer;
await writer.WriteFormattableAsync<int>(42, LengthFormat.Plain, Encoding.UTF8, "X"); // encode int as as set of bytes using UTF-8 encoding
```

The same change was applied to `IAsyncBinaryReader` interface. All methods for parsing various value types have been replaced with `ParseAsync` method. It accepts the delegate responsible for parsing of the value from the sequence of characters represented by `ReadOnlySpan<char>` data type:
```csharp
using System.Text;
using DotNext.IO;

IAsyncBinaryReader reader;
var i = await reader.ParseAsync<int>(static (chars, provider) => int.Parse(chars, provider: provider), Encoding.UTF8);
```

# Threading
`QueuedSynchronizer` and `Synchronizer` classes as well as `ISynchronizer` interface are merged into single `QueuedSynchronizer` class. Lock acquisition methods now return [ValueTask](https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.valuetask) or [ValueTask&lt;T&gt;](https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.valuetask-1) value type instead of [Task](https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task) class. If you still need a `Task` then use [AsTask()](https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.valuetask.astask) instance method.

## AsyncReaderWriterLock
Presence of upgradeable read lock was a huge mistake in architecture. It allows to upgrade the read lock to the write lock by concurrent flow, e.g.:
```csharp
using DotNext.Threading;

using var rwLock = new AsyncReaderWriterLock();

// async flow #1
await rwLock.EnterUpgradeableReadLockAsync();

// async flow #2
await rwLock.EnterWriteLockAsync(); // this flow can upgrade the existing read lock
```

To avoid that, starting from 4.0 version of the library you need to upgrade the lock manually:
```csharp
using DotNext.Threading;

using var rwLock = new AsyncReaderWriterLock();
await rwLock.EnterReadLockAsync();
await rwLock.UpgradeToWriteLockAsync();
```

`UpgradeToWriteLockAsync` should be called by the same flow after the invocation of `EnterReadLockAsync` method.

## AsyncTrigger
`AsyncTrigger` divided to two classes: generic `AsyncTrigger<T>` class and non-generic `AsyncTrigger` class. For producer-consumer scenario without coordinated state you need to use non-generic version. If you have coordinated state then use generic version. Read more [here](../features/threading/trigger.md) for detailed information about the differences.